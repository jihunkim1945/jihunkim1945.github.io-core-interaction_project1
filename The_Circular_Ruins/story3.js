// =========================
// The Circular Ruins — story3.js (FULL)  ✅ square reveal (no blur)
// =========================

const SCENES = [
  { bg: "../assets/images/d1.jpeg" },
  { bg: "../assets/images/d2.jpeg" },
  { bg: "../assets/images/d3.jpeg" },
  { bg: "../assets/images/d4.jpeg" },
];

// ====== FULL TEXT (원문 전체) ======
const FULL_TEXT = `
No one saw him disembark in the unanimous night, no one saw the bamboo canoe sink into the sacred mud, but in a few days there was no one who did not know that the taciturn man came from the South and that his home had been one of those numberless villages upstream in the deeply cleft side of the mountain, where the Zend language has not been contaminated by Greek and where leprosy is infrequent. What is certain is that the grey man kissed the mud, climbed up the bank with pushing aside (probably, without feeling) the blades which were lacerating his flesh, and crawled, nauseated and bloodstained, up to the circular enclosure crowned with a stone tiger or horse, which sometimes was the color of flame and now was that of ashes. This circle was a temple which had been devoured by ancient fires, profaned by the miasmal jungle, and whose god no longer received the homage of men. The stranger stretched himself out beneath the pedestal. He was awakened by the sun high overhead. He was not astonished to find that his wounds had healed; he closed his pallid eyes and slept, not through weakness of flesh but through determination of will. He knew that this temple was the place required for his invincible intent; he knew that the incessant trees had not succeeded in strangling the ruins of another propitious temple downstream which had once belonged to gods now burned and dead; he knew that his immediate obligation was to dream. Toward midnight he was awakened by the inconsolable shriek of a bird. Tracks of bare feet, some figs and a jug warned him that the men of the region had been spying respectfully on his sleep, soliciting his protection or afraid of his magic. He felt a chill of fear, and sought out a sepulchral niche in the dilapidated wall where he concealed himself among unfamiliar leaves.

The purpose which guided him was not impossible, though supernatural. He wanted to dream a man; he wanted to dream him in minute entirety and impose him on reality. This magic project had exhausted the entire expanse of his mind; if someone had asked him his name or to relate some event of his former life, he would not have been able to give an answer. This uninhabited, ruined temple suited him, for it is contained a minimum of visible world; the proximity of the workmen also suited him, for they took it upon themselves to provide for his frugal needs. The rice and fruit they brought him were nourishment enough for his body, which was consecrated to the sole task of sleeping and dreaming.

At first, his dreams were chaotic; then in a short while they became dialectic in nature. The stranger dreamed that he was in the center of a circular amphitheater which was more or less the burnt temple; clouds of taciturn students filled the tiers of seats; the faces of the farthest ones hung at a distance of many centuries and as high as the stars, but their features were completely precise. The man lectured his pupils on anatomy, cosmography, and magic: the faces listened anxiously and tried to answer understandingly, as if they guessed the importance of that examination which would redeem one of them from his condition of empty illusion and interpolate him into the real world. Asleep or awake, the man thought over the answers of his phantoms, did not allow himself to be deceived by imposters, and in certain perplexities he sensed a growing intelligence. He was seeking a soul worthy of participating in the universe.

After nine or ten nights he understood with a certain bitterness that he could expect nothing from those pupils who accepted his doctrine passively, but that he could expect something from those who occasionally dared to oppose him. The former group, although worthy of love and affection, could not ascend to the level of individuals; the latter pre-existed to a slightly greater degree. One afternoon (now afternoons were also given over to sleep, now he was only awake for a couple hours at daybreak) he dismissed the vast illusory student body for good and kept only one pupil. He was a taciturn, sallow boy, at times intractable, and whose sharp features resembled of those of his dreamer. The brusque elimination of his fellow students did not disconcert him for long; after a few private lessons, his progress was enough to astound the teacher. Nevertheless, a catastrophe took place. One day, the man emerged from his sleep as if from a viscous desert, looked at the useless afternoon light which he immediately confused with the dawn, and understood that he had not dreamed. All that night and all day long, the intolerable lucidity of insomnia fell upon him. He tried exploring the forest, to lose his strength; among the hemlock he barely succeeded in experiencing several short snatchs of sleep, veined with fleeting, rudimentary visions that were useless. He tried to assemble the student body but scarcely had he articulated a few brief words of exhortation when it became deformed and was then erased. In his almost perpetual vigil, tears of anger burned his old eyes.

He understood that modeling the incoherent and vertiginous matter of which dreams are composed was the most difficult task that a man could undertake, even though he should penetrate all the enigmas of a superior and inferior order; much more difficult than weaving a rope out of sand or coining the faceless wind. He swore he would forget the enormous hallucination which had thrown him off at first, and he sought another method of work. Before putting it into execution, he spent a month recovering his strength, which had been squandered by his delirium. He abandoned all premeditation of dreaming and almost immediately succeeded in sleeping a reasonable part of each day. The few times that he had dreams during this period, he paid no attention to them. Before resuming his task, he waited until the moon's disk was perfect. Then, in the afternoon, he purified himself in the waters of the river, worshiped the planetary gods, pronounced the prescribed syllables of a mighty name, and went to sleep. He dreamed almost immediately, with his heart throbbing.

He dreamed that it was warm, secret, about the size of a clenched fist, and of a garnet color within the penumbra of a human body as yet without face or sex; during fourteen lucid nights he dreampt of it with meticulous love. Every night he perceived it more clearly. He did not touch it; he only permitted himself to witness it, to observe it, and occasionally to rectify it with a glance. He perceived it and lived it from all angles and distances. On the fourteenth night he lightly touched the pulmonary artery with his index finger, then the whole heart, outside and inside. He was satisfied with the examination. He deliberately did not dream for a night; he took up the heart again, invoked the name of a planet, and undertook the vision of another of the principle organs. Within a year he had come to the skeleton and the eyelids. The innumerable hair was perhaps the most difficult task. He dreamed an entire man--a young man, but who did not sit up or talk, who was unable to open his eyes. Night after night, the man dreamt him asleep.

In the Gnostic cosmosgonies, demiurges fashion a red Adam who cannot stand; as a clumsy, crude and elemental as this Adam of dust was the Adam of dreams forged by the wizard's nights. One afternoon, the man almost destroyed his entire work, but then changed his mind. (It would have been better had he destroyed it.) When he had exhausted all supplications to the deities of earth, he threw himself at the feet of the effigy which was perhaps a tiger or perhaps a colt and implored its unknown help. That evening, at twilight, he dreamt of the statue. He dreamt it was alive, tremulous: it was not an atrocious bastard of a tiger and a colt, but at the same time these two firey creatures and also a bull, a rose, and a storm. This multiple god revealed to him that his earthly name was Fire, and that in this circular temple (and in others like it) people had once made sacrifices to him and worshiped him, and that he would magically animate the dreamed phantom, in such a way that all creatures, except Fire itself and the dreamer, would believe to be a man of flesh and blood. He commanded that once this man had been instructed in all the rites, he should be sent to the other ruined temple whose pyramids were still standing downstream, so that some voice would glorify him in that deserted ediface. In the dream of the man that dreamed, the dreamed one awoke.

The wizard carried out the orders he had been given. He devoted a certain length of time (which finally proved to be two years) to instructing him in the mysteries of the universe and the cult of fire. Secretly, he was pained at the idea of being seperated from him. On the pretext of pedagogical necessity, each day he increased the number of hours dedicated to dreaming. He also remade the right shoulder, which was somewhat defective. At times, he was disturbed by the impression that all this had already happened . . . In general, his days were happy; when he closed his eyes, he thought: Now I will be with my son. Or, more rarely: The son I have engendered is waiting for me and will not exist if I do not go to him.

Gradually, he began accustoming him to reality. Once he ordered him to place a flag on a faraway peak. The next day the flag was fluttering on the peak. He tried other analogous experiments, each time more audacious. With a certain bitterness, he understood that his son was ready to be born--and perhaps impatient. That night he kissed him for the first time and sent him off to the other temple whose remains were turning white downstream, across many miles of inextricable jungle and marshes. Before doing this (and so that his son should never know that he was a phantom, so that he should think himself a man like any other) he destroyed in him all memory of his years of apprenticeship.

His victory and peace became blurred with boredom. In the twilight times of dusk and dawn, he would prostrate himself before the stone figure, perhaps imagining his unreal son carrying out identical rites in other circular ruins downstream; at night he no longer dreamed, or dreamed as any man does. His perceptions of the sounds and forms of the universe became somewhat pallid: his absent son was being nourished by these diminution of his soul. The purpose of his life had been fulfilled; the man remained in a kind of ecstasy. After a certain time, which some chronicles prefer to compute in years and others in decades, two oarsmen awoke him at midnight; he could not see their faces, but they spoke to him of a charmed man in a temple of the North, capable of walking on fire without burning himself. The wizard suddenly remembered the words of the god. He remembered that of all the creatures that people the earth, Fire was the only one who knew his son to be a phantom. This memory, which at first calmed him, ended by tormenting him. He feared lest his son should meditate on this abnormal privilege and by some means find out he was a mere simulacrum. Not to be a man, to be a projection of another man's dreams--what an incomparable humiliation, what madness! Any father is interested in the sons he has procreated (or permitted) out of the mere confusion of happiness; it was natural that the wizard should fear for the future of that son whom he had thought out entrail by entrail, feature by feature, in a thousand and one secret nights.

His misgivings ended abruptly, but not without certain forewarnings. First (after a long drought) a remote cloud, as light as a bird, appeared on a hill; then, toward the South, the sky took on the rose color of leopard's gums; then came clouds of smoke which rusted the metal of the nights; afterwards came the panic-stricken flight of wild animals. For what had happened many centuries before was repeating itself. The ruins of the sanctuary of the god of Fire was destroyed by fire. In a dawn without birds, the wizard saw the concentric fire licking the walls. For a moment, he thought of taking refuge in the water, but then he understood that death was coming to crown his old age and absolve him from his labors. He walked toward the sheets of flame. They did not bite his flesh, they caressed him and flooded him without heat or combustion. With relief, with humiliation, with terror, he understood that he also was an illusion, that someone else was dreaming him.
`.trim();

// ===== split helper: cut near sentence boundary =====
function splitNearBoundary(str, nParts) {
  const s = str.replace(/\s+/g, " ").trim();
  const len = s.length;
  const target = len / nParts;

  const out = [];
  let start = 0;

  for (let i = 1; i <= nParts; i++) {
    if (i === nParts) {
      out.push(s.slice(start).trim());
      break;
    }

    let cut = Math.round(target * i);

    const window = 260;
    const left = Math.max(start + 120, cut - window);
    const right = Math.min(len - 1, cut + window);
    const seg = s.slice(left, right);

    const m = seg.match(/[\.\?\!;](?=\s)/g);
    if (m) {
      const last = seg.lastIndexOf(m[m.length - 1]);
      cut = left + last + 1;
    }

    out.push(s.slice(start, cut).trim());
    start = cut;
  }

  while (out.length < nParts) out.push("");
  return out;
}

function split4x4(full) {
  const scenes = splitNearBoundary(full, 4);
  return scenes.map((sc) => splitNearBoundary(sc, 4));
}

const TEXT = split4x4(FULL_TEXT); // TEXT[scene][card]

// ===== DOM =====
const bgImg = document.getElementById("bgImg");
const hotspot = document.getElementById("hotspot");
const reader = document.getElementById("reader");
const wakeDoor = document.getElementById("wakeDoor");
const turb = document.getElementById("turb");
const disp = document.getElementById("disp");

// wipe overlay (없으면 생성)
let wipe = document.getElementById("wipe");
if (!wipe) {
  wipe = document.createElement("div");
  wipe.className = "wipe";
  wipe.id = "wipe";
  document.querySelector(".app").appendChild(wipe);
}

// ===== state =====
let scene = 0;
let active = false;

let p = 0;  // current progress 0..4
let tp = 0; // target progress 0..4
const P_MAX = 4;

const EASE = 0.14;
const SPEED = 0.00135;

let cards = [];

// ===== utils =====
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
const lerp = (a, b, t) => a + (b - a) * t;

function escapeHtml(str) {
  return (str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function randomizeHotspot() {
  const w = 12 + Math.random() * 10;
  const h = 10 + Math.random() * 10;
  const x = 8 + Math.random() * (100 - w - 16);
  const y = 10 + Math.random() * (100 - h - 20);
  hotspot.style.setProperty("--hx", `${x}%`);
  hotspot.style.setProperty("--hy", `${y}%`);
  hotspot.style.setProperty("--hw", `${w}%`);
  hotspot.style.setProperty("--hh", `${h}%`);
}

function randomizeDoor() {
  const x = 6 + Math.random() * 88;
  const y = 10 + Math.random() * 80;
  const s = 28 + Math.random() * 10;
  wakeDoor.style.setProperty("--dx", `${x}vw`);
  wakeDoor.style.setProperty("--dy", `${y}vh`);
  wakeDoor.style.setProperty("--ds", `${s}px`);
}

function ensureStack() {
  let s = reader.querySelector(".stack");
  if (!s) {
    s = document.createElement("div");
    s.className = "stack";
    reader.appendChild(s);
  }
  return s;
}

function buildCards() {
  const stack = ensureStack();
  stack.innerHTML = "";
  cards = [];

  for (let i = 0; i < 4; i++) {
    const el = document.createElement("div");
    el.className = "card";
    el.style.zIndex = String(100 + i);

    const t = (TEXT?.[scene]?.[i] || "").trim();
    el.innerHTML = t ? `<div>${escapeHtml(t)}</div>` : `<div></div>`;

    // ✅ square reveal: inset starts closed (50%)
    el.style.setProperty("--inset", "50%");
    el.style.setProperty("--o", "0");
    el.style.setProperty("--s", "0.94");

    stack.appendChild(el);
    cards.push(el);
  }
}

function openReaderAt(clientX, clientY) {
  // reader position is controlled by CSS vars --bx/--by
  reader.style.setProperty("--bx", `${clientX}px`);
  reader.style.setProperty("--by", `${clientY}px`);

  if (active) return;
  active = true;
  p = 0;
  tp = 0;
  buildCards();
  applyProgress();
}

function closeReader() {
  active = false;
  p = 0;
  tp = 0;
  reader.querySelector(".stack")?.remove();
}

function playWipe() {
  wipe.classList.remove("play");
  void wipe.offsetWidth;
  wipe.classList.add("play");
}

function setScene(n, doWipe) {
  scene = (n + SCENES.length) % SCENES.length;
  if (doWipe) playWipe();

  bgImg.src = SCENES[scene].bg;

  // scene start: background only
  closeReader();
  randomizeHotspot();
  randomizeDoor();

  const next = new Image();
  next.src = SCENES[(scene + 1) % SCENES.length].bg;
}

function nextScene() {
  setScene(scene === SCENES.length - 1 ? 0 : scene + 1, true);
}

// ===== core: stacked cards reveal with continuous scroll (SQUARE) =====
function applyProgress() {
  for (let i = 0; i < cards.length; i++) {
    const local = clamp(p - i, 0, 1);

    // small “peek” so back cards begin to show slightly
    const peek = clamp(p - (i - 0.22), 0, 0.22) / 0.22; // 0..1

    // ✅ square reveal: inset 50% (closed) -> 0% (open)
    const inset = lerp(50, 0, local) - peek * 3;
    const insetClamped = clamp(inset, 0, 50);

    const s = lerp(0.94, 1.0, local) + peek * 0.008;
    const o = clamp(lerp(0.0, 1.0, local) + peek * 0.08, 0, 1);

    cards[i].style.setProperty("--inset", `${insetClamped.toFixed(2)}%`);
    cards[i].style.setProperty("--s", s.toFixed(4));
    cards[i].style.setProperty("--o", o.toFixed(4));
  }

  // end: wipe -> next scene background only
  if (p >= P_MAX - 0.001) {
    closeReader();
    playWipe();
    setTimeout(() => nextScene(), 900);
  }
}

// wheel => target progress
window.addEventListener(
  "wheel",
  (e) => {
    e.preventDefault();
    if (!active) return;
    tp = clamp(tp + e.deltaY * SPEED, 0, P_MAX);
  },
  { passive: false }
);

// hotspot hover => open at mouse position
hotspot.addEventListener("mouseenter", (e) => {
  openReaderAt(e.clientX, e.clientY);
});

// while open, keep box following cursor inside hotspot (원하면 지워도 됨)
hotspot.addEventListener("mousemove", (e) => {
  if (!active) return;
  reader.style.setProperty("--bx", `${e.clientX}px`);
  reader.style.setProperty("--by", `${e.clientY}px`);
});

// raf smooth
function tick() {
  if (active) {
    p += (tp - p) * EASE;
    applyProgress();
  }
  requestAnimationFrame(tick);
}

// mouse distortion (optional)
window.addEventListener("mousemove", (e) => {
  const mx = e.clientX / window.innerWidth;
  const my = e.clientY / window.innerHeight;

  const px = (mx - 0.5) * 18;
  const py = (my - 0.5) * 18;
  document.documentElement.style.setProperty("--bgx", `${px}px`);
  document.documentElement.style.setProperty("--bgy", `${py}px`);

  const bfX = 0.008 + mx * 0.010;
  const bfY = 0.008 + my * 0.010;
  turb?.setAttribute("baseFrequency", `${bfX.toFixed(4)} ${bfY.toFixed(4)}`);

  const sc = 14 + (Math.abs(mx - 0.5) + Math.abs(my - 0.5)) * 20;
  disp?.setAttribute("scale", sc.toFixed(1));
});

// subtle background breathing
let bt = 0;
function bgBreath() {
  bt += 0.008;
  const bgs = 1.03 + Math.sin(bt) * 0.006;
  document.documentElement.style.setProperty("--bgs", bgs.toFixed(4));
  requestAnimationFrame(bgBreath);
}

// init
setScene(0, false);
requestAnimationFrame(tick);
requestAnimationFrame(bgBreath);
function randomizeHotspot() {
  // ✅ 더 크게: 26~40%
  const w = 26 + Math.random() * 14; // 26~40%
  const h = 22 + Math.random() * 14; // 22~36%

  // 화면 밖으로 안 나가게 여백 조금
  const x = 6 + Math.random() * (100 - w - 12);
  const y = 8 + Math.random() * (100 - h - 16);

  hotspot.style.setProperty("--hx", `${x}%`);
  hotspot.style.setProperty("--hy", `${y}%`);
  hotspot.style.setProperty("--hw", `${w}%`);
  hotspot.style.setProperty("--hh", `${h}%`);
}
(() => {
  const audio = document.getElementById("bgm");
  if (!audio) return;

  audio.volume = 0.35;

  const start = async () => {
    try { await audio.play(); } catch (e) {}
    window.removeEventListener("pointerdown", start);
    window.removeEventListener("keydown", start);
  };

  window.addEventListener("pointerdown", start, { once: true });
  window.addEventListener("keydown", start, { once: true });
})();
